---
title: Split payments
---

import { CodeBlock, LinkOut } from '@interledger/docs-design-system'
import { Tabs, TabItem } from '@astrojs/starlight/components'
import HttpSig from '/src/partials/http-msg-sig-note.mdx'
import ChunkedSnippet from '/src/components/ChunkedSnippet.astro'
import Ts from '/src/partials/ts-prerequisites.mdx'

# Build an e-Commerce platform with split-payments between merchants and platform

This tutorial guides you through building an e-Commerce platform using Open Payments where split-payments are initiated by a buyer of a good or service and split between the merchant and you, the platform operator. Airbnb and Uber are popular platforms where payments made by guests and riders are split between the platform on one side and hosts and drivers on the other respectively.

## Dependencies

- <LinkOut href='https://github.com/interledger/open-payments/tree/main/packages/open-payments'>
    Open Payments SDK
  </LinkOut>

<HttpSig />

## Endpoints

- <LinkOut href='https://openpayments.dev/apis/auth-server/operations/post-request/'>
    Grant Request
  </LinkOut>
- <LinkOut href='https://openpayments.dev/apis/wallet-address-server/operations/get-wallet-address/'>
    Get a Wallet address
  </LinkOut>
- <LinkOut href='https://openpayments.dev/apis/resource-server/operations/create-incoming-payment/'>
    Create an Incoming Payment
  </LinkOut>
- <LinkOut href='https://openpayments.dev/apis/resource-server/operations/create-quote/'>
    Create a Quote
  </LinkOut>
- <LinkOut href='https://openpayments.dev/apis/resource-server/operations/create-outgoing-payment/'>
    Create an Outgoing Payment
  </LinkOut>

<Tabs>
<TabItem label='TypeScript'>
<Ts />

## Steps

### 1. Import dependencies

Import `createAuthenticatedClient` from the Open Payments SDK package.

<ChunkedSnippet
  source='https://raw.githubusercontent.com/interledger/open-payments-snippets/main/incoming-payment/incoming-payment-create.ts'
  chunk='1'
/>

### 2. Create an authenticated Open Payments client

Create an Open Payments-authenticated client by providing the following properties:

- `walletAddressURL` : your Open Payments-enabled wallet address that your client will use to authenticate itself to one or more Authorization Servers (AS).
- `privateKey` : the EdDSA-Ed25519 key or preferably the absolute or relative file path to the key that is bound to your wallet address. A public key signed with this private
  key must be made available as a public JWK document at `{walletAddressUrl}/jwks.json` url.
- `keyId` : the identifier of the private key and the corresponding public key.

<ChunkedSnippet
  source='https://raw.githubusercontent.com/interledger/open-payments-snippets/main/grant/grant-outgoing-payment.ts'
  chunk='2'
/>

### 3. Get WalletAddresses

Fetch wallet addresses of the buyer, merchant and your platform.

```ts
const merchantWalletAddress = await client.walletAddress.get({
  url: 'https://ASEabc.com/merchant'
})

const customerWalletAddress = await client.walletAddress.get({
  url: 'https://ASExyz.com/alice'
})

const platformWalletAddress = await client.walletAddress.get({
  url: 'https://ASEdef.com/platform'
})
```

### 4. Request an Incoming Payment grant for the merchant

Request an `incomingPayment` grant from the merchant's wallet's AS.

```ts
const grant = await client.grant.request(
  {
    url: merchantWalletAddress.authServer
  },
  {
    access_token: {
      access: [
        {
          type: 'incoming-payment',
          actions: ['list', 'read', 'read-all', 'complete', 'create']
        }
      ]
    }
  }
)
```

### 5. Request an Incoming Payment grant for your platform

Request an `incomingPayment` grant from your wallet's AS.

```ts
const grant = await client.grant.request(
  {
    url: platformWalletAddress.authServer
  },
  {
    access_token: {
      access: [
        {
          type: 'incoming-payment',
          actions: ['list', 'read', 'read-all', 'complete', 'create']
        }
      ]
    }
  }
)
```

### 6. Create an Incoming Payment for the merchant

Create an `incomingPayment` on the merchant's wallet's Resource Server (RS) using the access token returned by the AS in the grant request in step 4 and specify the `merchantWalletAddress` with the URL of the merchant's wallet.

Add the `incomingAmount` object and define the following properties:

- `value` : the maximum allowable amount that will be paid to the merchant's wallet address.
- `assetCode` : the ISO 4217 currency code representing the underlying asset used to make the payment.
- `assetScale` : the scale of amounts denoted in the corresponding asset code.

```ts
const incomingPayment = await client.incomingPayment.create(
  {
    url: new URL(WALLET_ADDRESS).origin,
    accessToken: INCOMING_PAYMENT_ACCESS_TOKEN
  },
  {
    merchantWalletAddress: WALLET_ADDRESS,
    incomingAmount: {
      value: '1000',
      assetCode: 'USD',
      assetScale: 2
    },
    expiresAt: new Date(Date.now() + 60_000 * 10).toISOString()
  }
)
```

### 7. Create an Incoming Payment for your platform

Create an `incomingPayment` on your platform's wallet's Resource Server (RS) using the access token returned by the AS in the grant request in step 5 and specify the `platformWalletAddress` with the URL of your wallet.

Add the `incomingAmount` object and define the following properties:

- `value` : the maximum allowable amount that will be paid to the merchant's wallet address.
- `assetCode` : the ISO 4217 currency code representing the underlying asset used to make the payment.
- `assetScale` : the scale of amounts denoted in the corresponding asset code.

```ts
const incomingPayment = await client.incomingPayment.create(
  {
    url: new URL(WALLET_ADDRESS).origin,
    accessToken: INCOMING_PAYMENT_ACCESS_TOKEN
  },
  {
    platformWalletAddress: WALLET_ADDRESS,
    incomingAmount: {
      value: '1000',
      assetCode: 'USD',
      assetScale: 2
    },
    expiresAt: new Date(Date.now() + 60_000 * 10).toISOString()
  }
)
```

### 8. Request an Outgoing Payment grant for the merchant

Request an `outgoingPayment` grant from the customer's wallet's AS.

Add the `limits` object with the following properties:

- `receiveAmount` : the maximum amount to be received in the merchant's wallet.
- `receiver` : the URL of the incoming payment for the merchant created in step 6.

:::note
This request requires an interactive grant as the send will need to consent before an `outgoingPayment` is made against their wallet.

For details on how to facilitate an interactive grant please see the <LinkOut href='https://openpayments.dev/guides/create-interactive-grant/'>
Create an Interactive Grant guide. </LinkOut>
:::

```ts
const grant = await client.grant.request(
  {
    url: customerWalletAddress.authServer
  },
  {
    access_token: {
      access: [
        {
          identifier: merchantWalletAddress.id,
          type: 'outgoing-payment',
          actions: ['list', 'list-all', 'read', 'read-all', 'create'],
          limits: {
            receiveAmount: {
              assetCode: receiveAmount.assetCode,
              assetScale: receiveAmount.assetScale,
              value: receiveAmount.value
            }
          }
        }
      ]
    },
    interact: {
      start: ['redirect'],
      finish: {
        method: 'redirect',
        uri: 'http://localhost:3344',
        nonce: NONCE
      }
    }
  }
)
```

### 9. Create an Outgoing Payment for the merchant

Create an `outgoingPayment` on the customer's wallet's RS using the access token returned by the AS in the grant request in step 8.

Add the following properties:

- `customerWalletAddress` : the URL of the customer's wallet address.

```ts
const outgoingPayment = await client.outgoingPayment.create(
  {
    url: new URL(WALLET_ADDRESS).origin,
    accessToken: OUTGOING_PAYMENT_ACCESS_TOKEN
  },
  {
    customerWalletAddress: WALLET_ADDRESS
  }
)
```

### 10. Request an Outgoing Payment grant for your platform

Request an `outgoingPayment` grant from the customer's wallet's AS.

Add the `limits` object with the following properties:

- `receiveAmount` : the maximum amount to be received in your wallet.
- `receiver` : the URL of the incoming payment for your platform created in step 7.

:::note
This request requires an interactive grant as the send will need to consent before an `outgoingPayment` is made against their wallet.

For details on how to facilitate an interactive grant please see the <LinkOut href='https://openpayments.dev/guides/create-interactive-grant/'>
Create an Interactive Grant guide. </LinkOut>
:::

```ts
const grant = await client.grant.request(
  {
    url: customerWalletAddress.authServer
  },
  {
    access_token: {
      access: [
        {
          identifier: platformWalletAddress.id,
          type: 'outgoing-payment',
          actions: ['list', 'list-all', 'read', 'read-all', 'create'],
          limits: {
            receiveAmount: {
              assetCode: receiveAmount.assetCode,
              assetScale: receiveAmount.assetScale,
              value: receiveAmount.value
            }
          }
        }
      ]
    },
    interact: {
      start: ['redirect'],
      finish: {
        method: 'redirect',
        uri: 'http://localhost:3344',
        nonce: NONCE
      }
    }
  }
)
```

/>

### 11. Create an Outgoing Payment for your platform

Create an `outgoingPayment` on the customer's wallet's RS using the access token returned by the AS in the grant request in step 10.

Add the following properties:

- `customerWalletAddress` : the URL of the customer's wallet address.

```ts
const outgoingPayment = await client.outgoingPayment.create(
  {
    url: new URL(WALLET_ADDRESS).origin,
    accessToken: OUTGOING_PAYMENT_ACCESS_TOKEN
  },
  {
    customerWalletAddress: WALLET_ADDRESS
  }
)
```

</TabItem>
</Tabs>
