---
title: Get an outgoing payment grant for future payments
---

import { LinkOut } from '@interledger/docs-design-system'
import { Tabs, TabItem, Badge } from '@astrojs/starlight/components'
import InteractionReq from '/src/partials/interaction-required.mdx'
import StartInteraction from '/src/partials/grant-start-interaction.mdx'
import FinishInteraction from '/src/partials/grant-finish-interaction.mdx'

:::tip[Summary]
Learn how to get an outgoing payment grant for future payments without specifying any recipients.
:::

Often, a transaction starts with the client getting the payment recipient's details and asking the recipient's ASE for permission to send money. However, Open Payments also supports a different approach: the client gets permission from the sender's ASE to send money before knowing who the recipient will be. Web Monetization's pay-as-you-browse model uses this approach.

**Real-life use case: Web Monetization browser extension**

The Web Monetization extension uses Open Payments to issue continuous outgoing payments to a web monetized site. The payments are issued on behalf of the user for as long as the user is on the site. The extension has no idea who the recipient will be until the user visits the site.

Setting up the extension requires the user to connect it to their wallet account. They specify a maximum amount they're willing to spend and select whether the amount should automatically renew each month. The extension then receives an outgoing payment grant from the user's wallet provider, allowing the extension to initiate future payments.

## Scenario

For this guide, you'll assume the role of an app developer. The guide explains how to allow your app's user to send payments of up to $100 CAD a month for three months without specifying a recipient beforehand.

## Endpoints

- <Badge text="GET" variant="note" />
  <LinkOut href="https://openpayments.dev/apis/wallet-address-server/operations/get-wallet-address/">
    Get Wallet Address
  </LinkOut>
- <Badge text="POST" variant="success" />
  <LinkOut href="https://openpayments.dev/apis/auth-server/operations/post-request/">
    Grant Request
  </LinkOut>
- <Badge text="POST" variant="success" />
  <LinkOut href="https://openpayments.dev/apis/auth-server/operations/post-continue/">
    Grant Continuation Request
  </LinkOut>

## Steps

### 1. Get wallet address information

Let's assume your user saved their wallet address in their account profile when setting up your app. Call the <Badge text="GET" variant="note" /> [Get Wallet Address API](/apis/wallet-address-server/operations/get-wallet-address).

<Tabs syncKey="lang">
<TabItem label='TypeScript/JavaScript' icon='seti:javascript'>
  ```ts
  const userWalletAddress = await client.walletAddress.get({
    url: 'https://cloudninebank.example.com/user'
  })
  ```
 </TabItem>
 <TabItem label='Rust' icon='seti:rust'>
 ```rust wrap
 let user_wallet_address = client.wallet_address().get("https://cloudninebank.example.com/user").await?;
 ```
 </TabItem>
 <TabItem label='Go' icon='seti:go'>
 
 ```go wrap
 userWalletAddress, err := client.WalletAddress.Get(context.TODO(), op.WalletAddressGetParams{
   URL: "https://cloudninebank.example.com/user",
 })
 if err != nil {
   log.Fatalf("Error fetching user wallet address: %v\n", err)
 }
```
</TabItem>
</Tabs>

<details>
  <summary>Example response</summary>
  ```json wrap
  {
    "id": "https://cloudninebank.example.com/user",
    "assetCode": "CAD",
    "assetScale": 2,
    "authServer": "https://auth.cloudninebank.example.com/",
    "resourceServer": "https://cloudninebank.example.com/op"
  }
  ```
</details>

### 2. Request an interactive outgoing payment grant

Use the authorization server information received in the previous step to call the <Badge text="POST" variant="success" /> [Grant Request API](/apis/auth-server/operations/post-request).

This call obtains a token that allows your app to request outgoing payment resources be created on your user's wallet account.

:::note

<InteractionReq />
:::

Remember, your user wants to send payments of up to $100 CAD a month for three months. The amount resets each month and any unspent portions don't roll over.
{/* prettier-ignore */}

<Tabs syncKey="lang">
<TabItem label='TypeScript/JavaScript' icon='seti:javascript'>
  ```ts
  const grant = await client.grant.request(
    {
      url: userWalletAddress.authServer,
    },
    {
      access_token: {
        access: [
          {
            identifier: userWalletAddress.id,
            type: 'outgoing-payment',
            actions: ['read', 'create'],
            limits: {
              interval: 'R3/2025-05-20T13:00:00Z/P1M'
              debitAmount: {
                assetCode: 'CAD',
                assetScale: 2,
                value: '10000',
              },
            },
          },
        ],
      },
      client: userWalletAddress.id,
      interact: {
        start: ['redirect'],
        finish: {
          method: 'redirect',
          uri: 'https://paymentplatform.example/finish/{...}', // where to redirect the user to after they've completed the interaction
          nonce: NONCE,
        },
      },
    },
  );
  ```
 </TabItem>
 <TabItem label='Rust' icon='seti:rust'>
 ```rust wrap
 use open_payments::types::{AccessTokenRequest, AccessItem, OutgoingPaymentAction, AccessLimits, Amount, InteractRequest, InteractStart, InteractFinish, InteractFinishMethod, GrantRequest};
 let outgoing_access = AccessTokenRequest {
   access: vec![AccessItem::OutgoingPayment {
     identifier: Some(user_wallet_address.id.clone()),
     actions: vec![OutgoingPaymentAction::Create, OutgoingPaymentAction::Read],
     limits: Some(AccessLimits {
       interval: Some("R3/2025-05-20T13:00:00Z/P1M".into()),
       debit_amount: Some(Amount { value: "10000".into(), asset_code: "CAD".into(), asset_scale: 2 }),
       ..Default::default()
     }),
   }],
 };
 let interact = InteractRequest { start: Some(vec![InteractStart::Redirect]), finish: Some(InteractFinish { method: InteractFinishMethod::Redirect, uri: Some("https://paymentplatform.example/finish/{...}".into()), nonce: Some("NONCE".into()) }) };
 let outgoing_grant_request = GrantRequest::new(outgoing_access, Some(interact));
 let pending_user_outgoing_payment_grant = client
   .grant()
   .request(&user_wallet_address.auth_server, &outgoing_grant_request)
   .await?;
 ```
 </TabItem>
<TabItem label='Go' icon='seti:go'>

```go wrap
interval := "R3/2025-05-20T13:00:00Z/P1M"
limits := as.LimitsOutgoing{}
if err := limits.FromLimitsOutgoing1(as.LimitsOutgoing1{
  Interval: &interval,
  DebitAmount: as.Amount{
    Value:      "10000",
    AssetCode:  "CAD",
    AssetScale: 2,
  },
}); err != nil {
  log.Fatalf("Error creating limits: %v\n", err)
}

outgoingAccess := as.AccessOutgoing{
  Type: as.OutgoingPayment,
  Actions: []as.AccessOutgoingActions{as.AccessOutgoingActionsCreate, as.AccessOutgoingActionsRead},
  Identifier: *userWalletAddress.Id,
  Limits: &limits,
}
outgoingAccessItem := as.AccessItem{}
if err := outgoingAccessItem.FromAccessOutgoing(outgoingAccess); err != nil {
  log.Fatalf("Error creating AccessItem: %v\n", err)
}
outgoingAccessToken := struct {
  Access as.Access `json:"access"`
}{
  Access: []as.AccessItem{outgoingAccessItem},
}
interact := &as.InteractRequest{
  Start: []as.InteractRequestStart{as.InteractRequestStartRedirect},
  Finish: &as.InteractRequestFinish{
  Method: as.Redirect,
  Uri: "https://paymentplatform.example/finish/{...}",
  Nonce: NONCE,
  },
}

pendingUserOutgoingPaymentGrant, err := client.Grant.Request(context.TODO(), op.GrantRequestParams{
  URL: *userWalletAddress.AuthServer,
  RequestBody: as.GrantRequestWithAccessToken{
    AccessToken: outgoingAccessToken,
    Interact: interact,
  },
})
if err != nil {
  log.Fatalf("Error requesting outgoing payment grant: %v\n", err)
}
```

</TabItem>
</Tabs>

<details>
  <summary>Example response</summary>
```json wrap
{
  "interact": {
    "redirect": "https://auth.cloudninebank.example.com/{...}", // uri to redirect the user to, to begin interaction
    "finish": "..." // unique key to secure the callback
  },
  "continue": {
    "access_token": {
      "value": "..." // access token for continuing the outgoing payment grant request
    },
    "uri": "https://auth.cloudninebank.example.com/continue/{...}", // uri for continuing the outgoing payment grant request
    "wait": 30
  }
}
```
</details>

#### About the interval

The interval used in this guide is `R3/2025-05-20T13:00:00Z/P1M`. Your user wants to send payments up to $100 CAD a month for three months. The interval breaks down like this:

- `R3/` is the number of repetitions - three.
- `2025-05-20` is the start date of the repeating interval - 20 May 2025
- `T13:00:00Z/` is the start time of the repeating interval - 1:00 PM UTC.
- `P1M` is the period between each interval - one month. Used with `R3/`, you have a grant that's valid once a month for three months.

Altogether, your user can send up to $100 CAD from:

- 1 PM UTC on 20 May 2025 through 12:59 PM UTC on 20 June 2025
- 1 PM UTC on 20 June 2025 through 12:59 PM UTC on 20 July 2025
- 1 PM UTC on 20 July 2025 through 12:59 PM UTC on 20 August 2025

### 3. Start interaction with your user

<StartInteraction />

### 4. Finish interaction with your user

<FinishInteraction />

### 5. Request a grant continuation

In our example, we're assuming the IdP the user interacted with has a user interface. When the interaction completes, your user is directed back to your app. Now the client can make a grant continuation request.

:::note
In a scenario where a user interface isn't available, consider implementing a polling mechanism to check for the completion of the interaction.
:::

Call the <Badge text="POST" variant="success" /> [Grant Continuation Request API](/apis/auth-server/operations/post-continue/). This call requests an access token that allows your app to request outgoing payment resources be created on the user's wallet account.

Issue the request to the `continue.uri` provided in the initial outgoing payment grant response (Step 2).

Include the `interact_ref` returned in the redirect URI's query parameters.

<Tabs syncKey='lang'>
  <TabItem label='TypeScript/JavaScript' icon='seti:javascript'>
  ```ts wrap
  const userOutgoingPaymentGrant = await client.grant.continue(
    {
      accessToken: pendingUserOutgoingPaymentGrant.continue.acces_token.value,
      url: pendingUserOutgoingPaymentGrant.continue.uri,
    },
    {
      interact_ref: interactRef,
    },
  );
  ```
  </TabItem>
  <TabItem label='Rust' icon='seti:rust'>
  ```rust wrap
  let continue_field = match &pending_user_outgoing_payment_grant.continue_field {
    Some(c) => c,
    None => {
      eprintln!("Missing continue field on pending grant");
      return Ok(());
    }
  };
  let user_outgoing_payment_grant = client
    .grant()
    .continue_grant(
      &continue_field.uri,
      &interact_ref,
      Some(&continue_field.access_token.value),
    )
    .await?;
  ```
  </TabItem>

  <TabItem label='Go' icon='seti:go'>
  
  ```go wrap
  userOutgoingPaymentGrant, err := client.Grant.Continue(context.TODO(), op.GrantContinueParams{
    URL:         pendingUserOutgoingPaymentGrant.Continue.Uri,
    AccessToken: pendingUserOutgoingPaymentGrant.Continue.AccessToken.Value,
    InteractRef: INTERACT_REF,
  })
  if err != nil {
    log.Fatalf("Error continuing grant: %v\n", err)
  }
  ```
  </TabItem>
</Tabs>

A successful response provides your app with an access token. Now your app can issue outgoing payment requests to future recipients against the grant. Each request must reference the access token.

<details>
  <summary>Example response</summary>
  ```json wrap
  {
    "access_token": {
      "value": "...", // final access token required before creating outgoing payments
      "manage": "https://auth.cloudninebank.example.com/token/{...}", // management uri for access token
      "access": [
        {
          "type": "outgoing-payment",
          "actions": ["create", "read"],
          "identifier": "https://cloudninebank.example.com/user",
        }
      ]
    },
    "continue": {
      "access_token": {
        "value": "..." // access token for continuing the request
      },
      "uri": "https://auth.cloudninebank.example.com/continue/{...}" // continuation request uri
    }
  }
  ```
</details>

:::note[Access token expiry]
If an outgoing payment request fails because the grant's access token has expired, you can call the <Badge text="POST" variant="success" /> [Rotate Access Token API](/apis/auth-server/operations/post-token/), then use the new token in the outgoing payment request.
:::
