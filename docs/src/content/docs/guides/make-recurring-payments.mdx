---
title: Make recurring payments
---

import { CodeBlock, LinkOut } from '@interledger/docs-design-system'
import { Tabs, TabItem } from '@astrojs/starlight/components'
import HttpSig from '/src/partials/http-msg-sig-note.mdx'
import ChunkedSnippet from '/src/components/ChunkedSnippet.astro'
import Ts from '/src/partials/ts-import-initialize.mdx'
import StartInteraction from '/src/partials/grant-start-interaction.mdx'
import FinishInteraction from '/src/partials/grant-finish-interaction.mdx'

:::tip[Summary]
Add support for recurring payments to your client. A recurring payment requires the sender's authorization once, then automatically pays out at regular intervals.
:::

The Open Payments APIs facilitate multiple use cases for recurring payments to and from Open Payments-enabled wallets. Buy Now Pay Later (BNPL) is one example, where a purchaser pays for an item in installments over regularly scheduled intervals.

This guide provides steps for making recurring payments, in which a single outgoing payment grant is used to create multiple outgoing payment resources at defined intervals.

## Dependencies

- <LinkOut href='https://github.com/interledger/open-payments/tree/main/packages/open-payments'>
    Open Payments SDK
  </LinkOut>

<HttpSig />

## Endpoints

- <LinkOut href='https://openpayments.dev/apis/auth-server/operations/post-request/'>
    Grant Request
  </LinkOut>
- <LinkOut href='https://openpayments.dev/apis/wallet-address-server/operations/get-wallet-address/'>
    Get a Wallet address
  </LinkOut>
- <LinkOut href='https://openpayments.dev/apis/resource-server/operations/create-incoming-payment/'>
    Create an Incoming Payment
  </LinkOut>
- <LinkOut href='https://openpayments.dev/apis/resource-server/operations/create-quote/'>
    Create a Quote
  </LinkOut>
- <LinkOut href='https://openpayments.dev/apis/resource-server/operations/create-outgoing-payment/'>
    Create an Outgoing Payment
  </LinkOut>
- <LinkOut href='https://openpayments.dev/apis/auth-server/operations/post-token/'>
    Rotate an Access Token
  </LinkOut>

<Tabs>
<TabItem label='TypeScript'>
<Ts />

## Steps

### 1. Get recipient's wallet address information

<ChunkedSnippet
  source='https://raw.githubusercontent.com/interledger/open-payments-snippets/main/grant/grant-outgoing-payment.ts'
  chunk='3'
/>

### 2. Request an Incoming Payment grant

Request an `incomingPayment` grant from the recipient wallet's authorization server.

<ChunkedSnippet
  source='https://raw.githubusercontent.com/interledger/open-payments-snippets/main/grant/grant-incoming-payment.ts'
  chunk='4'
/>

### 3. Create an Incoming Payment

Create an `incomingPayment` on the recipient wallet's resource server using the access token returned by the authorization server in the grant request and specify the `walletAddress` with the URL of the recipient's wallet.

Add the `incomingAmount` object and define the following properties:

- `value` : the maximum allowable amount that will be paid to the recipient's wallet address.
- `assetCode` : the ISO 4217 currency code representing the underlying asset used to make the payment.
- `assetScale` : the scale of amounts denoted in the corresponding asset code.

Optionally you may add the `expiresAt` property which is the date and time after which payments to the incoming payments will no longer be accepted.

<ChunkedSnippet
  source='https://raw.githubusercontent.com/interledger/open-payments-snippets/main/incoming-payment/incoming-payment-create.ts'
  chunk='3'
/>

### 4. Request a Quote grant

Request a `quote` grant from the sender wallet's authorization server.

<ChunkedSnippet
  source='https://raw.githubusercontent.com/interledger/open-payments-snippets/main/grant/grant-quote.ts'
  chunk='4'
/>

### 5. Create a Quote

Create a `quote` on the sender wallet's resource server using the access token returned by the authorization server in the grant request.

Add the following properties:

- `method` : the payment method used to facilitate the payment. Set this property to `ilp` as Open Payments only supports <LinkOut href='https://interledger.org'>Interledger</LinkOut> payments at this time.
- `walletAddress` : the URL of the sender's wallet address.
- `receiver` : the URL of the incoming payment that will receive the payment.

<ChunkedSnippet
  source='https://raw.githubusercontent.com/interledger/open-payments-snippets/main/quote/quote-create.ts'
  chunk='3'
/>

### 6. Request an interactive Outgoing Payment grant

Request an `outgoingPayment` grant from the sender wallet's authorization server. This request requires an interactive grant as the sender will need to consent before an `outgoingPayment` is made against their wallet.

Add the `limits` object with the one of the following properties:

- `debitAmount` : the maximum amount to be deducted from the sender's wallet.
- `receiveAmount` : the maximum amount to be received in the recipient's wallet.

Then add the `interval` property to the `limits` object, which is the interval period conforming to the <LinkOut href="https://en.wikipedia.org/wiki/ISO_8601#Repeating_intervals">ISO8601 repeating interval string format.</LinkOut>

:::note[Limits]

The `debitAmount` and `receiveAmount` parameters, which apply to the sender and recipient respectively, allow you to define the limits under which an outgoing payment can be created. Select the parameter most appropriate for your particular use case. Specify the `receiveAmount` when the recipient must receive a defined amount. Specify the `debitAmount` for cases when the sender can exercise a limit on the amount that can be debited from their account.

The `value` for either parameter is the amount that all payments created under the grant cannot exceed. For example, the `DEBIT_AMOUNT` value is the maximum amount that can be debited from the sender's wallet.
:::

Next, indicate your client is capable of directing the user to a URI to start an interaction.

1. Add the `interact` object to your grant request.
2. Specify `redirect` as the `start` mode. Open Payments only supports `redirect` at this time. The redirect URI will be provided by the authorization server in its response.

Now indicate your client can receive a signal from the authorization server when the interaction has finished.

1. Add the `finish` object within the `interact` object.
2. Specify `redirect` as the `method`. Open Payments only supports `redirect` at this time.
3. Specify the `uri` that the authorization server will send the user back to when the interaction has finished.
4. Create a `nonce` for your client to use to verify the authorization server is the same entity throughout the entire process. The nonce can be any random, hard-to-guess string.

<ChunkedSnippet
  source='https://raw.githubusercontent.com/interledger/open-payments-snippets/main/grant/grant-outgoing-payment.ts'
  chunk='4'
/>

<ChunkedSnippet
  source='https://raw.githubusercontent.com/interledger/open-payments-snippets/main/grant/grant-outgoing-payment.ts'
  chunk='5'
/>

### 7. Start interaction with the user

<StartInteraction />

### 8. Finish interaction with the user

<FinishInteraction />

### 9. Request a grant continuation

After the user completes their interaction with the identity provider (IdP), they should be redirected back to your application. Now you can make the grant continuation request. In scenarios where a user interface is not available, consider implementing a polling mechanism to check for the completion of the interaction.

Add the authorization server’s interaction reference as the `interact_ref` value to the body of your continuation request.

<ChunkedSnippet
  source='https://raw.githubusercontent.com/interledger/open-payments-snippets/main/grant/grant-continuation.ts'
  chunk='3'
/>

Issue the request to the `continue uri` supplied in the authorization server’s initial grant response. For example:

`POST https://auth.interledger-test.dev/continue/4CF492MLVMSW9MKMXKHQ`

A successful continuation response from the authorization server provides your client with an access token and other information necessary to continue the transaction.

```json title="Example response" wrap
{
  "access_token": {
    "value": "OS9M2PMHKUR64TB8N6BW7OZB8CDFONP219RP1LT0",
    "manage": "https://auth.interledger-test.dev/token/dd17a202-9982-4ed9-ae31-564947fb6379",
    "expires_in": 3600,
    "access": [
      {
        "type": "outgoing-payment",
        "actions": ["create", "read", "read-all", "list", "list-all"],
        "identifier": "https://ilp.interledger-test.dev/alice",
        "limits": {
          "receiver": "https://ilp.interledger-test.dev/bob/incoming-payments/48884225-b393-4872-90de-1b737e2491c2",
          "interval": "R12/2019-08-24T14:15:22Z/P1M",
          "debitAmount": {
            "value": "500",
            "assetCode": "USD",
            "assetScale": 2
          }
        }
      }
    ]
  },
  "continue": {
    "access_token": {
      "value": "33OMUKMKSKU80UPRY5NM"
    },
    "uri": "https://auth.interledger-test.dev/continue/4CF492MLVMSW9MKMXKHQ",
    "wait": 30
  }
}
```

### 10. Create an initial Outgoing Payment

Create an `outgoingPayment` on the sender wallet's resource server using the access token returned by the authorization server in the grant request.

Add the following properties:

- `walletAddress` : the URL of the sender's wallet address.
- `quoteId` : the URL of the quote specifying the payment amount.

<ChunkedSnippet
  source='https://raw.githubusercontent.com/interledger/open-payments-snippets/main/outgoing-payment/outgoing-payment-create.ts'
  chunk='3'
/>

### 11. Rotate the Access Token

:::note
This step is only required if the access token you obtained in the previous `outgoingPayment` grant request has expired.
:::

Rotate the access token obtained from the previous `outgoingPayment` grant request.

<ChunkedSnippet
  source='https://raw.githubusercontent.com/interledger/open-payments-snippets/main/token/token-rotate.ts'
  chunk='3'
/>

### 12. Create another Outgoing Payment

Create another `outgoingPayment` on the sender wallet's resource server using the new access token returned by the authorization server in the previous step.

Add the following properties:

- `walletAddress` : the URL of the sender's wallet address.
- `quoteId` : the URL of the quote specifying the payment amount.

<ChunkedSnippet
  source='https://raw.githubusercontent.com/interledger/open-payments-snippets/main/outgoing-payment/outgoing-payment-create.ts'
  chunk='3'
/>

### 13. Make recurring Outgoing Payments

Repeat steps 11 and 12 to facilitate as many payments as needed by your application.

</TabItem>
</Tabs>
