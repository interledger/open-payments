---
title: Make a one-time purchase from an online store
---

import { LinkOut } from '@interledger/docs-design-system'
import { Tabs, TabItem } from '@astrojs/starlight/components'
import InteractionReq from '/src/partials/interaction-required.mdx'
import StartInteraction from '/src/partials/grant-start-interaction.mdx'
import FinishInteraction from '/src/partials/grant-finish-interaction.mdx'

:::tip[Summary]
Learn how to create a single, non-recurring payment with an `incomingAmount` addressed to a single recipient.
:::

Making a one-time payment (OTP) to a single recipient is one of the more common transaction flows. OTPs facilitate a number of use cases, such as online purchases, peer-to-peer payments, and remittances.

Depending on the use case, the transaction will have a defined `incomingAmount`, `debitAmount`, or `receiveAmount`.

- `incomingAmount` - The maximum amount to pay toward an incoming payment. It's possible to pay less, but not more.
- `debitAmount` - A fixed amount to pay from the sender toward an incoming payment. It's possible for the incoming payment to receive less than the `debitAmount`, depending on fees and other factors.
- `receiveAmount` - A fixed amount to pay into an incoming payment. It's possible for the amount paid by the sender to be greater than the `receiveAmount` depending on fees and other factors.

In this guide, you'll assume the role of an app developer for an online store. The guide takes you through the steps your app will perform to facilitate a customer's one-time purchase by setting an `incomingAmount` when creating the incoming payment resource. In this example, the customer's total comes to €35.00.

## Endpoints

- <LinkOut href='https://openpayments.dev/apis/wallet-address-server/operations/get-wallet-address/'>
    Get a Wallet address
  </LinkOut>
- <LinkOut href='https://openpayments.dev/apis/auth-server/operations/post-request/'>
    Grant Request
  </LinkOut>
- <LinkOut href='https://openpayments.dev/apis/resource-server/operations/create-incoming-payment/'>
    Create an Incoming Payment
  </LinkOut>
- <LinkOut href='https://openpayments.dev/apis/resource-server/operations/create-quote/'>
    Create a Quote
  </LinkOut>
- <LinkOut href='https://openpayments.dev/apis/resource-server/operations/create-outgoing-payment/'>
    Create an Outgoing Payment
  </LinkOut>

## Steps

### 1. Get wallet address information

When a customer initiates a payment, you must get the wallet address information for the customer and for the store.

Let's assume the store's wallet address is built into your app. Let's also assume the customer provided their wallet address at the beginning of the checkout flow.

Call the [Get Wallet Address API](/apis/wallet-address-server/operations/get-wallet-address) for each address.

<Tabs syncKey="lang">
<TabItem label="TypeScript/JavaScript" icon="seti:javascript">
```ts 
const customerWalletAddress = await client.walletAddress.get({
  url: 'https://cloudninebank.example.com/customer'
});

const storeWalletAddress = await client.walletAddress.get({
url: 'https://happylifebank.example.com/store'
});

````
</TabItem>
</Tabs>

### 2. Request an incoming payment grant

Use the store's `authServer` details, received in the previous step, to call the [Grant Request API](/apis/auth-server/operations/post-request).

The purpose of this call is to obtain an access token that will allow your app to request an incoming payment resource be created on the store's wallet account.

<Tabs syncKey="lang">
<TabItem label="TypeScript/JavaScript" icon="seti:javascript">
```ts wrap
const storeIncomingPaymentGrant = await client.grant.request(
  {
    url: storeWalletAddress.authServer,
  },
  {
    access_token: {
      access: [
        {
          type: "incoming-payment",
          actions: ["read", "create"],
        },
      ],
    },
  },
);
````

</TabItem>
</Tabs>

### 3. Request the creation of an incoming payment resource

Use the access token returned in the previous response to call the [Create Incoming Payment API](/apis/resource-server/operations/create-incoming-payment).

The purpose of this call is to request an incoming payment resource be created on the store's wallet account.

Include the following in the request, along with any other required parameters.

- `incomingAmount` object
  - `value` - The maximum amount to pay into a given wallet address.
  - `assetCode` - The code used by the wallet account, provided in the Get Wallet Address API's response.
  - `assetScale` - The scale used by the wallet account, provided in the Get Wallet Address API's response.

Remember that the customer's total comes to €35.00.

<Tabs syncKey="lang">
<TabItem label="TypeScript/JavaScript" icon="seti:javascript">
```ts wrap
const storeIncomingPayment = await client.incomingPayment.create(
  {
    url: storeWalletAddress.resourceServer,
    accessToken: storeIncomingPaymentGrant.access_token.value
  },
  {
    walletAddress: storeWalletAddress.id,
    incomingAmount: {
      value: '3500',
      assetCode: 'EUR',
      assetScale: 2
    },
  },
)
```
</TabItem>
</Tabs>

### 4. Request a quote grant

Use the customer's `authServer` details, received in Step 1, to call the [Grant Request API](/apis/auth-server/operations/post-request).

The purpose of this call is to obtain an access token that allows your app to request a quote resource be created on the customer's wallet account.

<Tabs syncKey="lang">
<TabItem label="TypeScript/JavaScript" icon="seti:javascript">
```ts wrap
const customerQuoteGrant = await client.grant.request(
  {
    url: customerWalletAddress.authServer
  },
  {
    access_token: {
      access: [
        {
          type: 'quote',
          actions: ['create', 'read']
        }
      ]
    }
  }
)
```
</TabItem>
</Tabs>

### 5. Request the creation of a quote resource

Use the access token, received in the previous step, to call the [Create Quote API](/apis/resource-server/operations/create-quote).

The purpose of this call is to request a quote resource be created on the customer's wallet account.

The request must contain the `receiver`, which is the store's incoming payment `id`, along with any other required parameters. The `id` was returned in Step 3 when the incoming payment resource was created.

<Tabs syncKey="lang">
<TabItem label='TypeScript/JavaScript' icon='seti:javascript'>
```ts wrap
const storeQuote = await client.quote.create(
  {
    url: customerWalletAddress.resourceServer,
    accessToken: customerQuoteGrant.access_token.value
  },
  {
    method: 'ilp',
    walletAddress: customerWalletAddress.id,
    receiver: storeIncomingPayment.id
  }
)
```
</TabItem>
</Tabs>

The response returns a `receiveAmount`, a `debitAmount`, and other required information.

- `receiveAmount` - The `incomingAmount` value from the incoming payment resource (in this case, `3500`)
- `debitAmount` - The amount the customer must pay toward the incoming payment resource (`receiveAmount` plus any applicable fees)

### 6. Request an interactive outgoing payment grant

Use the customer's `authServer` information received in Step 1 to call the [Grant Request API](/apis/auth-server/operations/post-request).

The purpose of this call is to obtain an access token that allows your app to request an outgoing payment resource be created on the customer's wallet account.

<InteractionReq />

Include the following in the request, along with any other required parameters.

- `limits` object
  - `receiveAmount` object
    - `value` - The total amount the customer has agreed to pay.
    - `assetCode` - The code used by the wallet account, provided in the Get Wallet Address API’s response.
    - `assetScale` - The scale used by the wallet account, provided in the Get Wallet Address API’s response.

<Tabs syncKey="lang">
<TabItem label="TypeScript/JavaScript" icon="seti:javascript">
``` ts wrap
const pendingCustomerOutgoingPaymentGrant = await client.grant.request(
  {
    url: customerWalletAddress.authServer
  },
  {
    access_token: {
      access: [
        {
          identifier: customerWalletAddress.id,
          type: 'outgoing-payment',
          actions: ['read', 'create'],
          limits: {
            receiveAmount: {
              assetCode: 'EUR',
              assetScale: 2,
              value: '3600'
            }
          }
        }
      ]
    },
    interact: {
      start: ['redirect'],
      finish: {
        method: 'redirect',
        uri: 'http://localhost:3344',
        nonce: NONCE
      }
    }
  }
)
```
</TabItem>
</Tabs>

### 7. Start interaction with the customer

<StartInteraction />

### 8. Finish interaction with the customer

<FinishInteraction />

### 9. Request a grant continuation

In our example, we're assuming the IdP the customer interacted with has a user interface. When the interaction completes, the customer returns to your app. Now your app can make a continuation request for the outgoing payment grant.

:::note
In a scenario where a user interface isn't available, consider implementing a polling mechanism to check for the completion of the interaction.
:::

Call the [Grant Continuation Request API](/apis/auth-server/operations/post-continue). The purpose of this call is to request an access token that allows your app to request an outgoing payment resource be created on the customer's wallet account.

Issue the request to the `continue uri` provided in the initial outgoing payment grant response (Step 6). For example:

`POST https://auth.interledger-test.dev/continue/4CF492MLVMSW9MKMXKHQ`

Include the `interact_ref` returned in the redirect URI's query parameters.

<Tabs syncKey="lang">
<TabItem label='TypeScript/JavaScript' icon='seti:javascript'>
```ts wrap
const customerOutgoingPaymentGrant = await client.grant.continue(
  {
    url: pendingCustomerOutgoingPaymentGrant.continue.uri,
    accessToken: pendingCustomerOutgoingPaymentGrant.continue.access_token.value
  },
  {
    interact_ref: interactRef
  }
)
```
</TabItem>
</Tabs>

### 10. Request the creation of an outgoing payment resource

Recall that the Create Quote API response for the store (Step 5) included a `debitAmount` and a `receiveAmount`. The response also included an `id` which is a URL to identify the quote.

Because the quote contains debit and receive amounts, we won’t specify any other amounts when making a Create Outgoing Payment API request. Instead, we will specify a `quoteId`.

Use the access token returned in Step 5 to call the [Create Outgoing Payment API](/apis/resource-server/operations/create-outgoing-payment).

The purpose of this call is to request an outgoing payment resource be created on the customer’s wallet account. Include the `quoteId` in the request.

<Tabs syncKey="lang">
<TabItem label='TypeScript/JavaScript' icon='seti:javascript'>
```ts wrap
const customerOutgoingPayment = await client.outgoingPayment.create(
  {
    url: customerWalletAddress.resourceServer,
    accessToken: customerOutgoingPaymentGrant.access_token.value
  },
  {
    walletAddress: customerWalletAddress.id,
    quoteId: storeQuote.id
  }
)
```
</TabItem>
</Tabs>
