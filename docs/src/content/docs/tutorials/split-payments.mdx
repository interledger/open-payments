---
title: Create a split-payments application
---

import { CodeBlock, LinkOut } from '@interledger/docs-design-system'
import { Tabs, TabItem } from '@astrojs/starlight/components'
import HttpSig from '/src/partials/http-msg-sig-note.mdx'
import ChunkedSnippet from '/src/components/ChunkedSnippet.astro'
import Ts from '/src/partials/ts-prerequisites.mdx'

This tutorial guides you to build an application that supports split-payments using the Open Payments SDK. Split-payments are common on online marketplaces where multiple merchants sell their goods and services on one platform. When a customer purchases an item on the marketplace, you, as the platform operator, can split the payment between yourself and the merchant according to a percentage split. Airbnb and Uber are examples of platforms where payments made by guests and riders are split between the platform on one side and hosts and drivers on the other, respectively.

In the split-payments use case, there are three parties to the transaction:

- Customer: the purchaser of a good or service on the marketplace
- Merchant: the seller of a good or service on the marketplace
- Platform: the operator of the marketplace

In this tutorial you will assume the role of the platform operator integrating split-payments using Open Payments with your online marketplace.

## Endpoints

- <LinkOut href='https://openpayments.dev/apis/auth-server/operations/post-request/'>
    Grant Request
  </LinkOut>
- <LinkOut href='https://openpayments.dev/apis/wallet-address-server/operations/get-wallet-address/'>
    Get a Wallet address
  </LinkOut>
- <LinkOut href='https://openpayments.dev/apis/resource-server/operations/create-quote/'>
    Create a Quote
  </LinkOut>
- <LinkOut href='https://openpayments.dev/apis/resource-server/operations/create-incoming-payment/'>
    Create an Incoming Payment
  </LinkOut>
- <LinkOut href='https://openpayments.dev/apis/resource-server/operations/create-outgoing-payment/'>
    Create an Outgoing Payment
  </LinkOut>

<Tabs>
<TabItem label='TypeScript'>
<Ts />

## Steps

### 1. Fetch wallet addresses

Fetch the wallet addresses of the buyer, merchant, and your marketplace platform. In this example, we assume each party has their Open Payments-enabled account with a different account servicing entity.

```ts
const customerWalletAddress = await client.walletAddress.get({
  url: 'https://gatehub.net/buyer'
})

const merchantWalletAddress = await client.walletAddress.get({
  url: 'https://chimoney.io/merchant'
})

const platformWalletAddress = await client.walletAddress.get({
  url: 'https://interledger.app/platform'
})
```

### 2. Request Incoming Payment grants

Request `incomingPayment` grants from your wallet authorization server as well as from the merchant wallet authorization server.

<Tabs>
<TabItem label = 'Merchant'>
```ts 
const merchantGrant = await client.grant.request(
  {
    url: merchantWalletAddress.authServer,
  },
  {
    access_token: {
      access: [
        {
          type: "incoming-payment",
          actions: ["read", "create"],
        },
      ],
    },
  },
);
```
</TabItem>
<TabItem label = 'Platform'>
```ts
const platformGrant = await client.grant.request(
  {
    url: platformWalletAddress.authServer,
  },
  {
    access_token: {
      access: [
        {
          type: "incoming-payment",
          actions: ["read", "create"],
        },
      ],
    },
  },
);
```
</TabItem>
</Tabs>

### 3. Create Incoming Payment resources

Create `incomingPayment` resources using the access tokens returned from the authorizations servers in step 2. Since this example assumes the merchant and the platform operator are using different account servicing entities, the `incomingPayment` resources will be created on the respective resource servers.

In this example you will split the payment and give the merchant 99% on a $100 payment, while retaining 1% for your fee as the platform operator.

<Tabs>
<TabItem label = 'Merchant'>

```ts
const merchantIncomingPayment = await client.incomingPayment.create(
  {
    url: new URL(WALLET_ADDRESS).origin,
    accessToken: INCOMING_PAYMENT_ACCESS_TOKEN
  },
  {
    merchantWalletAddress: WALLET_ADDRESS,
    incomingAmount: {
      value: '9900',
      assetCode: 'USD',
      assetScale: 2
    },
    expiresAt: new Date(Date.now() + 60_000 * 10).toISOString()
  }
)
```

</TabItem>

<TabItem label = 'Platform'>

```ts
const platformIncomingPayment = await client.incomingPayment.create(
  {
    url: new URL(WALLET_ADDRESS).origin,
    accessToken: INCOMING_PAYMENT_ACCESS_TOKEN
  },
  {
    platformWalletAddress: WALLET_ADDRESS,
    incomingAmount: {
      value: '100',
      assetCode: 'USD',
      assetScale: 2
    },
    expiresAt: new Date(Date.now() + 60_000 * 10).toISOString()
  }
)
```

</TabItem>
</Tabs>

### 4. Request quote grants

Request two quote grants from the customer wallet authorization server, as there are two recipients on this payment.

```ts
const grant = await client.grant.request(
  {
    url: walletAddress.authServer
  },
  {
    access_token: {
      access: [
        {
          type: 'quote',
          actions: ['create', 'read']
        }
      ]
    }
  }
)
```

### 5. Request quotes

Request two quote resources from the customer wallet resource server using the access tokens returned in Step 4. Specify the respective `incomingPayment` URLs returned in Step 3 for each of the quotes.

```ts
const quote = await client.quote.create(
  {
    url: new URL(WALLET_ADDRESS).origin,
    accessToken: QUOTE_ACCESS_TOKEN
  },
  {
    method: 'ilp',
    walletAddress: WALLET_ADDRESS,
    receiver: INCOMING_PAYMENT_URL
  }
)
```

### 5. Request an interactive outgoing payment grant

Request an `outgoingPayment` grant from the customer wallet authorization server.

Add the `limits` object with the following properties:

- `receiveAmount` : the total maximum amount to be received and then split between the merchant's wallet and your platform's wallet.

:::note
This request requires an interactive grant as the customer will need to consent before an `outgoingPayment` is made against their wallet.
:::

```ts
const grant = await client.grant.request(
  {
    url: customerWalletAddress.authServer
  },
  {
    access_token: {
      access: [
        {
          identifier: merchantWalletAddress.id,
          type: 'outgoing-payment',
          actions: ['read', 'create'],
          limits: {
            receiveAmount: {
              assetCode: receiveAmount.assetCode,
              assetScale: receiveAmount.assetScale,
              value: receiveAmount.value
            }
          }
        }
      ]
    },
    interact: {
      start: ['redirect'],
      finish: {
        method: 'redirect',
        uri: 'http://localhost:3344',
        nonce: NONCE
      }
    }
  }
)
```

### 6. Create outgoing payments

Create two `outgoingPayment` resources on the customer wallet resource server using the access token returned by the authorization server in the grant request in step 5.

<Tabs>
<TabItem label = 'Merchant'>

Add the following properties:

- `walletAddress` : the URL of the customer wallet address.
- `quoteId `: the URL of the quote specifying the payment amount to be paid to the merchant.

```ts
const outgoingPayment = await client.outgoingPayment.create(
  {
    url: new URL(WALLET_ADDRESS).origin,
    accessToken: OUTGOING_PAYMENT_ACCESS_TOKEN
  },
  {
    walletAddress: WALLET_ADDRESS,
    quoteId: QUOTE_URL
  }
)
```

</TabItem>

<TabItem label ='Platform'>
Add the following properties:

- `walletAddress` : the URL of the customer wallet address.
- `quoteId `: the URL of the quote specifying the payment amount to be paid to the platform.

```ts
const outgoingPayment = await client.outgoingPayment.create(
  {
    url: new URL(WALLET_ADDRESS).origin,
    accessToken: OUTGOING_PAYMENT_ACCESS_TOKEN
  },
  {
    walletAddress: WALLET_ADDRESS,
    quoteId: QUOTE_URL
  }
)
```

</TabItem>
</Tabs>

</TabItem>
</Tabs>
