---
title: Build a split payments marketplace
---

import { CodeBlock, LinkOut } from '@interledger/docs-design-system'
import { Tabs, TabItem } from '@astrojs/starlight/components'
import HttpSig from '/src/partials/http-msg-sig-note.mdx'
import ChunkedSnippet from '/src/components/ChunkedSnippet.astro'
import Ts from '/src/partials/ts-prerequisites.mdx'
import Dependencies from '/src//partials/dependencies.mdx'

This tutorial directs you to build a marketplace that supports split payments using Open Payments. Your marketplace will allow multiple merchants to sell their goods and services on your platform. When a buyer purchases an item on the marketplace, you, as the platform operator, can split the payment between yourself and the merchant. Airbnb and Uber are examples of platforms where payments made by guests and riders are split between the platform on one side and hosts and drivers on the other, respectively.

In the split-payments use case, there are three parties to the transaction:

- Buyer: the purchaser of a good or service on the marketplace
- Platform: the operator of the marketplace
- Merchant: the seller of a good or service on the marketplace

You will assume the role of the platform operator in this tutorial.

## Dependencies

<Dependencies />

## Endpoints

- <LinkOut href='https://openpayments.dev/apis/auth-server/operations/post-request/'>
    Grant Request
  </LinkOut>
- <LinkOut href='https://openpayments.dev/apis/wallet-address-server/operations/get-wallet-address/'>
    Get a Wallet address
  </LinkOut>
- <LinkOut href='https://openpayments.dev/apis/resource-server/operations/create-incoming-payment/'>
    Create an Incoming Payment
  </LinkOut>
- <LinkOut href='https://openpayments.dev/apis/resource-server/operations/create-outgoing-payment/'>
    Create an Outgoing Payment
  </LinkOut>

<Tabs>
<TabItem label='TypeScript'>
<Ts />

## Steps

### 1. Request an Incoming Payment grant for the merchant

Request an `incomingPayment` grant from the merchant's wallet's AS.

```ts
const grant = await client.grant.request(
  {
    url: merchantWalletAddress.authServer
  },
  {
    access_token: {
      access: [
        {
          type: 'incoming-payment',
          actions: ['list', 'read', 'read-all', 'complete', 'create']
        }
      ]
    }
  }
)
```

### 2. Request an Incoming Payment grant for your platform

Request an `incomingPayment` grant from your wallet's AS.

```ts
const grant = await client.grant.request(
  {
    url: platformWalletAddress.authServer
  },
  {
    access_token: {
      access: [
        {
          type: 'incoming-payment',
          actions: ['list', 'read', 'read-all', 'complete', 'create']
        }
      ]
    }
  }
)
```

### 3. Create an Incoming Payment for the merchant

Create an `incomingPayment` on the merchant's wallet's Resource Server (RS) using the access token returned by the AS in the grant request in step 1 and specify the `merchantWalletAddress` with the URL of the merchant's wallet.

Add the `incomingAmount` object and define the following properties:

- `value` : the maximum allowable amount that will be paid to the merchant's wallet address.
- `assetCode` : the ISO 4217 currency code representing the underlying asset used to make the payment.
- `assetScale` : the scale of amounts denoted in the corresponding asset code.

```ts
const merchantIncomingPayment = await client.incomingPayment.create(
  {
    url: new URL(WALLET_ADDRESS).origin,
    accessToken: INCOMING_PAYMENT_ACCESS_TOKEN
  },
  {
    merchantWalletAddress: WALLET_ADDRESS,
    incomingAmount: {
      value: '1000',
      assetCode: 'USD',
      assetScale: 2
    },
    expiresAt: new Date(Date.now() + 60_000 * 10).toISOString()
  }
)
```

### 4. Create an Incoming Payment for your platform

Create an `incomingPayment` on your marketplace platform's wallet's Resource Server (RS) using the access token returned by the AS in the grant request in step 2 and specify the `platformWalletAddress` with the URL of your wallet.

Add the `incomingAmount` object and define the following properties:

- `value` : the maximum allowable amount that will be paid to the merchant's wallet address.
- `assetCode` : the ISO 4217 currency code representing the underlying asset used to make the payment.
- `assetScale` : the scale of amounts denoted in the corresponding asset code.

```ts
const incomingPayment = await client.incomingPayment.create(
  {
    url: new URL(WALLET_ADDRESS).origin,
    accessToken: INCOMING_PAYMENT_ACCESS_TOKEN
  },
  {
    walletAddress: PLATFORM_WALLET_ADDRESS,
    incomingAmount: {
      value: '1000',
      assetCode: 'USD',
      assetScale: 2
    },
    expiresAt: new Date(Date.now() + 60_000 * 10).toISOString()
  }
)
```

### 5. Request an Outgoing Payment grant

Request an `outgoingPayment` grant from the customer's wallet's AS.

Add the `limits` object with the following properties:

- `receiveAmount` : the total maximum amount to be received and then split between the merchant's wallet and your platform's wallet.

:::note
This request requires an interactive grant as the send will need to consent before an `outgoingPayment` is made against their wallet.

For details on how to facilitate an interactive grant please see the <LinkOut href='https://openpayments.dev/guides/create-interactive-grant/'>
Create an Interactive Grant guide. </LinkOut>
:::

```ts
const grant = await client.grant.request(
  {
    url: customerWalletAddress.authServer
  },
  {
    access_token: {
      access: [
        {
          identifier: merchantWalletAddress.id,
          type: 'outgoing-payment',
          actions: ['list', 'list-all', 'read', 'read-all', 'create'],
          limits: {
            receiveAmount: {
              assetCode: receiveAmount.assetCode,
              assetScale: receiveAmount.assetScale,
              value: receiveAmount.value
            }
          }
        }
      ]
    },
    interact: {
      start: ['redirect'],
      finish: {
        method: 'redirect',
        uri: 'http://localhost:3344',
        nonce: NONCE
      }
    }
  }
)
```

### 6. Create an Outgoing Payment for the merchant

Create an `outgoingPayment` on the customer's wallet's RS using the access token returned by the AS in the grant request in step 5.

Add the following properties:

- `customerWalletAddress` : the URL of the customer's wallet address.

```ts
const outgoingPayment = await client.outgoingPayment.create(
  {
    url: new URL(WALLET_ADDRESS).origin,
    accessToken: OUTGOING_PAYMENT_ACCESS_TOKEN
  },
  {
    customerWalletAddress: WALLET_ADDRESS
  }
)
```

### 7. Create an Outgoing Payment for your platform

Create an `outgoingPayment` on the customer's wallet's RS using the access token returned by the AS in the grant request in step 5.

Add the following properties:

- `customerWalletAddress` : the URL of the customer's wallet address.

```ts
const outgoingPayment = await client.outgoingPayment.create(
  {
    url: new URL(WALLET_ADDRESS).origin,
    accessToken: OUTGOING_PAYMENT_ACCESS_TOKEN
  },
  {
    customerWalletAddress: WALLET_ADDRESS
  }
)
```

</TabItem>
</Tabs>
